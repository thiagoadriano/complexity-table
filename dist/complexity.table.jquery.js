/**
 * @class: ComplexityTable jQuery
 * @description: Classe para criação da tabela com cabeçalhos e dados dinamicos com congelamento do cabeçalho e colunas
 * @version: 1.0.4
 * @author: Thiago Adriano <thiago.s.adriano@gmail.com>
 * @copyright: Thiago Adriano ©2016
 * @license: MIT license
*/
!function($){"use strict";var CT={};CT.existGroup=!1,CT.Page=1,CT.TotalRegistros=0,CT.TotalPages=0,CT.Params="",CT.COlTotal=0,CT.idContiner=null,CT.rowSpanData=!1;var opt={},htmlTemplate='<div class="ct-wrap"><div class="ct-wraper"><table><thead></thead><tbody></tbody></table></div></div>',wrap=null,wraper=null,table=null,thead=null,tbody=null,defaults={urlDados:"",urlCabecalho:"",parametros:[],limite:0,destacar:!1,Tamanhos:{celula:{width:95,height:30},PrimeiraCelula:{width:150,height:30},UltimaCelula:{width:150,height:30}},container:{width:900,height:528},colFixedLeft:!1,colTwoFixedLeft:!1,colFixedRight:!1,classes:{fixedLeft:"fixed-left",fixedRight:"fixed-right",fixedTwo:"fixed-two",fixedCol:"fixed-col",bgHeadColor:"head-bg-color",linhaPar:"odd-line",linhaImpar:"even-line",realce:"highlight",existeRealce:"hl-show"},nomePropriedades:{indicador:"indicador",valores:"status",registros:"totalRegistros",cabecalhos:"cabecalhos"},onClickLink:null};CT.getHead=function(url,callback){$.ajax({url:url+CT.URLParams(),method:"GET",async:!1,success:function(res){CT.CheckIntegrityProperty(res,opt.nomePropriedades.cabecalhos)&&CT.CheckIntegrityProperty(res,opt.nomePropriedades.registros)&&(CT.TotalRegistros=res[opt.nomePropriedades.registros],CT.setTotalPages(),CT.checkExistGroup(res[opt.nomePropriedades.cabecalhos]),callback(res[opt.nomePropriedades.cabecalhos]))},error:function(err,e,w,r){throw CT.ExceptionError("Erro inesperado aconteceu ao carregar as informações de cabeçalhos.<br><br>"+err.statusText+"<br>"+err.responseText).show(),console.error(err),new Error(err.responseText)}})},CT.getData=function(url,callback){$.ajax({url:url+CT.URLParams(),method:"GET",success:function(res){CT.CheckFirstCellRowSpanData(res[0].status),callback(res)},error:function(err){throw CT.ExceptionError("Erro inesperado aconteceu ao carregar as informações.<br><br>"+err.statusText+"<br>"+err.responseText).show(),console.error(err),new Error(err.responseText)}})},CT.URLParams=function(){return opt.limite>0?"?skip="+opt.limite+"&page="+CT.Page+CT.Params:"?"+CT.Params.replace(/^&/,"")},CT.setTotalPages=function(){opt.limite>0&&CT.TotalRegistros>0&&(CT.TotalPages=Math.ceil(CT.TotalRegistros/opt.limite))},CT.mountParams=function(){CT.isArray(opt.parametros)&&(opt.parametros.forEach(function(item){for(var j in item)CT.Params+=j+"="+item[j]+"&"}),CT.Params=CT.Params.replace(/&$/,"").replace(/^(.*)/,"&$1"))},CT.DefineTableWidth=function(){return opt.Tamanhos.celula.width*CT.COlTotal+opt.Tamanhos.PrimeiraCelula+opt.Tamanhos.UltimaCelula+"px"},CT.isArray=function(data){return Array.isArray(data)&&data.length>0?data:null},CT.checkExistGroup=function(data){CT.isArray(data)&&data.forEach(function(item){if(null!==item.grupo&&item.grupo.length)return CT.existGroup=!0,!0})},CT.createHead=function(data){var trs=[],trHead=$("<tr/>");if(CT.existGroup){var trGroup=$("<tr/>"),tamW=opt.Tamanhos.celula.width,tamH=opt.Tamanhos.celula.height,leftFirsCol=opt.colFixedLeft?opt.Tamanhos.PrimeiraCelula.width:tamW,calcPrevGroup=0;data.forEach(function(el,i,arr){var th=$("<th/>");null!==el.grupo&&el.grupo.length>0?(CT.HeadTreatment(th,el,tamW,tamH,leftFirsCol,calcPrevGroup,i),trGroup.append(th),CT.HeadSubGroup(el,trHead,tamW,tamH,th),calcPrevGroup=parseInt(th.css("width"),10)+parseInt(th.css("left"),10)):(CT.MountHeadNoGroup(th,tamH,el,i,el.nome.value),CT.ConfCheckLastCell(i,arr,th,calcPrevGroup),CT.setFirstCellWidth(i,th),trGroup.append(th),CT.COlTotal++)}),trs.push(trGroup),trs.push(trHead)}else data.forEach(function(el){trHead.append("<th><span>"+el.nome.value+"</span></th>")}),trs.push(trHead);return trs},CT.HeadTreatment=function(th,el,tamW,tamH,leftFirsCol,calcPrevGroup,i){th.html("<span>"+el.nome.value+"</span>").attr("colspan",el.grupo.length).addClass(opt.classes.bgHeadColor).css(CT.configCellGroup(el,tamW,tamH,leftFirsCol,calcPrevGroup,i)),CT.MountLink(el.nome,th,el.nome.value)},CT.HeadSubGroup=function(el,trHead,tamW,tamH,th){el.grupo.forEach(function(item,j){var th2l=$("<th><span>"+item.value+"</span></th>");th2l.css(CT.configCellChildrenGroup(tamW,tamH,th,j)).addClass(opt.classes.bgHeadColor),CT.MountLink(item,th2l,item.value),trHead.append(th2l),CT.COlTotal++})},CT.MountHeadNoGroup=function(th,tamH,el,i,indicador){th.css(CT.configCellNoGroup(tamH,i)).html("<span>"+el.nome.value+"</span>").addClass(opt.classes.bgHeadColor),(1===i&&opt.colTwoFixedLeft||0===i&&opt.colFixedLeft)&&th.addClass(opt.classes.fixedCol),CT.MountLink(el.nome,th,indicador)},CT.NormalizeArray=function(arr){var totalColunasSemPrimeira=CT.COlTotal-1;if(totalColunasSemPrimeira>arr.length)for(var diff=totalColunasSemPrimeira-arr.length,i=0;i<diff;i++)arr.push({value:"--"});return arr},CT.setFirstCellWidth=function(i,th){(0===i||opt.colTwoFixedLeft&&1===i)&&th.css({width:1===i?opt.Tamanhos.celula.width:opt.Tamanhos.PrimeiraCelula.width,left:1===i?opt.Tamanhos.PrimeiraCelula.width*i:opt.Tamanhos.celula.width*i})},CT.ConfCheckLastCell=function(i,arr,th){i===arr.length-1&&(opt.colFixedRight&&i===arr.length-1?th.css({right:0,width:opt.Tamanhos.UltimaCelula.width}).addClass(opt.classes.fixedCol):th.css({left:opt.Tamanhos.celula.width*CT.COlTotal+(opt.Tamanhos.PrimeiraCelula.width-opt.Tamanhos.celula.width),width:opt.Tamanhos.celula.width}))},CT.configCellNoGroup=function(tamH,i){return{width:i<1?opt.Tamanhos.PrimeiraCelula.width:opt.Tamanhos.celula.width,height:CT.existGroup?2*tamH:tamH,top:0,zIndex:i<1?4:3}},CT.configCellChildrenGroup=function(tamW,tamH,th,j){return{width:tamW,height:tamH,left:j>0?parseInt(th.css("left"))+opt.Tamanhos.celula.width*j:th.css("left"),top:tamH}},CT.configCellGroup=function(el,tamW,tamH,leftFirsCol,calcPrevGroup,i){return{width:tamW*el.grupo.length,height:tamH,left:1!==i||opt.colTwoFixedLeft?2===i&&opt.colTwoFixedLeft?leftFirsCol+tamW:calcPrevGroup:leftFirsCol*CT.COlTotal}},CT.creteLineData=function(res){if(CT.isArray(res)){var trs=[];return res.forEach(function(item,i){var jumpClasse=i%2===0?opt.classes.linhaPar:opt.classes.linhaImpar;if(CT.rowSpanData){var voltas=0;item.status.forEach(function(el){var tr=$("<tr/>");CT.HighlightEvent(tr),CT.InsertCellFirstData(item,jumpClasse,tr,i,res,voltas),CT.InsertValues(el,jumpClasse,tr,item[opt.nomePropriedades.indicador].value),trs.push(tr),voltas++})}else{var tr=$("<tr/>");CT.HighlightEvent(tr),CT.InsertCellFirstData(item,jumpClasse,tr,i,res),CT.InsertValues(item,jumpClasse,tr,item[opt.nomePropriedades.indicador].value),trs.push(tr)}}),trs}return[]},CT.InsertCellFirstData=function(item,jumpClasse,tr,i,arr,voltas){if(CT.CheckIntegrityProperty(item,opt.nomePropriedades.indicador)){var voltas=voltas||0,tdFirst=$("<td><span>"+item[opt.nomePropriedades.indicador].value+"</span></td>");CT.checkInsertLink(item,tdFirst,!0,item[opt.nomePropriedades.indicador].value),opt.colFixedLeft&&tdFirst.addClass(opt.classes.fixedLeft),CT.rowSpanData&&tdFirst.attr("rowspan",2),voltas>0&&tdFirst.css({visibility:"hidden",opacity:0,top:0,zIndex:-1}),tdFirst.css(CT.ConfigFirstCell(i,arr)).addClass(jumpClasse),tr.append(tdFirst)}},CT.InsertValues=function(item,jumpClasse,tr,indicador){var list=$.isArray(item)?item:item.status;list=CT.NormalizeArray(list),list.forEach(function(val,i,arr){var tdval=$("<td><span>"+val.value+"</span></td>");CT.checkInsertLink(val,tdval,!1,indicador),tdval.css(CT.ConfigCell()).addClass(jumpClasse),CT.setFixedCollineData(i,arr,tdval),CT.FixedTwoCol(tdval,i),tr.append(tdval)})},CT.checkInsertLink=function(itemCol,tdFirst,firstCol,indicador){var item=itemCol instanceof Object&&!firstCol?itemCol:firstCol?itemCol[opt.nomePropriedades.indicador]:itemCol[opt.nomePropriedades.valores];if(Array.isArray(item))for(var i in item)CT.MountLink(item[i],tdFirst,indicador);else CT.MountLink(item,tdFirst,indicador)},CT.MountLink=function(item,celula,indicador){if(void 0!==item&&item.hasOwnProperty("link")&&"#"!==item.link&&""!==item.link&&opt.onClickLink){var td=celula,span=td.find("span"),text=span.text(),a=$("<a>"+text+"</a>");a.on("click",function(event){event.preventDefault(),opt.onClickLink(event,opt.parametros,item.link,indicador)}).css({cursor:"pointer",textDecoration:"underline"}),span.html(""),span.append(a)}},CT.setFixedCollineData=function(i,arr,tdval){opt.colFixedRight&&i===arr.length-1&&tdval.addClass(opt.classes.fixedRight).css(CT.ConfigLastCell())},CT.FixedTwoCol=function(td,i){opt.colTwoFixedLeft&&0===i&&td.addClass(opt.classes.fixedLeft).addClass(opt.classes.fixedTwo).css({left:opt.Tamanhos.PrimeiraCelula.width})},CT.ConfigFirstCell=function(i,arr){return{height:CT.rowSpanData?2*opt.Tamanhos.celula.height+2:opt.Tamanhos.PrimeiraCelula.height,width:opt.Tamanhos.PrimeiraCelula.width,minWidth:opt.Tamanhos.PrimeiraCelula.width,maxWidth:opt.Tamanhos.PrimeiraCelula.width,top:(CT.rowSpanData?2*opt.Tamanhos.celula.height*i+i:opt.Tamanhos.celula.height*i)+(CT.existGroup?2*opt.Tamanhos.celula.height:opt.Tamanhos.celula.height)+i}},CT.CheckFirstCellRowSpanData=function(array){2===array.length&&Array.isArray(array[0])&&(CT.rowSpanData=!0)},CT.ConfigLastCell=function(){return{width:opt.Tamanhos.UltimaCelula.width,minWidth:opt.Tamanhos.UltimaCelula.width,maxWidth:opt.Tamanhos.UltimaCelula.width}},CT.ConfigCell=function(){return{height:opt.Tamanhos.celula.height,width:opt.Tamanhos.celula.width,maxWidth:opt.Tamanhos.celula.width,minWidth:opt.Tamanhos.celula.width}},CT.insertHead=function(el,callback){CT.getHead(opt.urlCabecalho,function(res){CT.createHead(res).forEach(function(el){thead.append($(el))}),CT.getData(opt.urlDados,function(res){CT.creteLineData(res).forEach(function(el){tbody.append(el)}),callback(el,wrap)})})},CT.scrollEvent=function(){wraper.on("scroll",function(e){var trs=tbody.find("tr"),fixedL=tbody.find("."+opt.classes.fixedLeft),fixedR=tbody.find("."+opt.classes.fixedRight),fixed2=tbody.find("."+opt.classes.fixedTwo),tds=trs.eq(0).find("td"),ths=thead.find("th").filter(function(){if(!$(this).hasClass(opt.classes.fixedCol))return this}),thCell=[],thGroup=[];ths.filter(function(){$(this).attr("colspan")||$(this).hasClass(opt.classes.fixedCol)?thGroup.push(this):thCell.push(this)});var tempPosi=1,totalGrupo=thGroup.length,grupoPercorrido=0;trs.each(function(i,item){var position=$(item).position();fixedL.eq(opt.colTwoFixedLeft?2*i:i).css("top",position.top),fixedR.eq(i).css("top",position.top),opt.colTwoFixedLeft&&fixed2.eq(i).css("top",position.top)}),tds.each(function(i,item){var move=opt.colTwoFixedLeft?tds[i+1>=tds.length?tds.length-1:i+1]:item,position=$(move).position(),id=i-1;$(thCell).eq(id).css("left",position.left),i===tempPosi&&grupoPercorrido<totalGrupo&&($(thGroup).eq(grupoPercorrido).css("left",position.left),tempPosi+=parseInt($(thGroup).eq(grupoPercorrido).attr("colspan")),grupoPercorrido++)}),CT.getDataScroll(e)})},CT.getDataScroll=function(e){var temptr=table.find("tbody tr"),posiLasttr=temptr.eq(temptr.length-1).offset().top,posi=e.currentTarget.offsetTop+parseInt(wraper.height(),10);opt.limite>0&&posi>=posiLasttr&&CT.Page<=CT.TotalPages&&CT.getData(opt.urlDados,function(res){CT.Page++})},CT.HighlightEvent=function(el){opt.destacar&&(el.addClass(opt.classes.existeRealce),el.on("click",function(e){"a"!==e.target.tagName.toLowerCase()&&($(this).hasClass(opt.classes.realce)?$(this).removeClass(opt.classes.realce):$(this).addClass(opt.classes.realce),CT.lineHighligthRowSpan(e,$(this)))}))},CT.lineHighligthRowSpan=function(event,element){if(CT.rowSpanData){var index=event.currentTarget.rowIndex-2,line="visible"===element.find("td").eq(0).css("visibility")?index+1:index-1,tr=$("table tbody").find("tr");tr.eq(line).hasClass(opt.classes.realce)?tr.eq(line).removeClass(opt.classes.realce):tr.eq(line).addClass(opt.classes.realce)}},CT.MountPrincipalContainer=function(el){$(el).css({position:"relative",width:opt.container.width,height:opt.container.height,marginLeft:"auto",marginRight:"auto"})},CT.MountTable=function(el,content){CT.MountContainer(content),table.css({width:CT.DefineTableWidth()}),el.append(wrap),CT.Loading().hide(),CT.Alert("Dados carregados com sucesso!",1).showInterval(2e3)},CT.MountContainer=function(wrap){var heightGroup=CT.existGroup?2*opt.Tamanhos.celula.height:opt.Tamanhos.celula.height,widthPadding=opt.colFixedLeft?opt.Tamanhos.PrimeiraCelula.width:0,widthfixColRigth=opt.colFixedRight?opt.Tamanhos.UltimaCelula.width:0;wrap.css({width:opt.colTwoFixedLeft?opt.container.width-widthPadding-opt.Tamanhos.celula.width:opt.container.width-widthPadding,height:opt.container.height-heightGroup,paddingLeft:opt.colTwoFixedLeft?widthPadding+opt.Tamanhos.celula.width:widthPadding,paddingTop:heightGroup,background:opt.corCabecalho}),wraper.css({width:opt.colTwoFixedLeft?opt.container.width-(widthPadding+widthfixColRigth)-opt.Tamanhos.celula.width:opt.container.width-(widthPadding+widthfixColRigth),height:opt.container.height-heightGroup})},CT.Loading=function(el){var template=$("<div class='ct-loader'><p>Aguarde, Carregando...</p></div>");return{show:function(){$(el).append(template)},hide:function(){$(".ct-loader").fadeOut("1000",function(){$(this).remove()})}}},CT.ExceptionError=function(msg){var template=$("<div id='ct-exception'><h2>Erro na aplicação</h2><p></p></div>"),p=template.find("p");return p.html(msg),{show:function(){$("#"+CT.idContiner).find("div").remove(),$("#"+CT.idContiner).html(""),$("#"+CT.idContiner).append(template)},hide:function(){$("#ct-exception").fadeOut("1000",function(){$(this).remove()})}}},CT.Alert=function(msg,type){var typeEvent=1===type?"ct-success":2===type?"ct-warning":"ct-error",id="ct-info",template=$('<div id="'+id+'" class="'+typeEvent+'" ><button type="button">X</button><p></p></div>'),p=template.find("p"),button=template.find("button"),txtMsg=null!==msg&&""!==msg&&void 0!==msg?msg:"Erro ao realizar o procedimento.";p.text(txtMsg);var clicked=function(){button.on("click",function(){_close()})},_show=function(){$("#"+id).is(":visible")&&$("#"+id).remove(),clicked(),$("body").append(template)},_close=function(){$("#"+id).fadeOut(800,function(){$(this).remove()})},_showInterval=function(time){var timer=time||5e3;_show(),setTimeout(_close,timer)};return{show:_show,close:_close,showInterval:_showInterval}},CT.Init=function(){var that=this;wrap=$(htmlTemplate),wraper=wrap.find(".ct-wraper"),table=wraper.find("table"),thead=table.find("thead"),tbody=table.find("tbody"),CT.Loading(that).show(),CT.mountParams(opt.parametros),CT.insertHead(that,function(el,content){CT.MountTable(el,content)}),CT.scrollEvent()},CT.BuildStartCheck=function(){if(!opt.urlCabecalho&&""===opt.urlCabecalho)throw CT.Alert("A URL para buscar os  cabecalhos a serem inseridos não foi informada.",2).show(),new Error("Necessário informar url para buscar os cabeçalhos");if(!opt.urlDados&&""===opt.urlDados)throw CT.Alert("A URL para buscar os valores a serem inseridos não foi informada.",2).show(),new Error("Necessário informar url para buscar os dados");return opt.colTwoFixedLeft&&!opt.colFixedLeft&&(opt.colFixedLeft=!0),!0},CT.CheckIntegrityProperty=function(data,prop){try{if(!data.hasOwnProperty(prop))throw new Error("A propriedade: <strong>"+prop+"</strong>, não faz parte dos dados. <br>"+JSON.stringify(data))}catch(e){CT.ExceptionError("Os dados possuem inconsistência<br><br>"+e).show(),console.error(e)}return!0},CT.ClearVariables=function(){CT.existGroup=!1,CT.Page=1,CT.TotalRegistros=0,CT.TotalPages=0,CT.Params="",CT.COlTotal=0,CT.idContiner=null,CT.rowSpanData=!1,opt={},wrap=null,wraper=null,table=null,thead=null,tbody=null},$.fn.ComplexityTable=function(options){if("string"==typeof options&&"destroy"===options){var wrap=$(this).find(".ct-wrap");if(wrap.length){var link=wrap.find("a");link.off().remove(),wrap.remove(),$(this).off().removeAttr("style"),CT.ClearVariables()}}else if(options instanceof Object){var that=this;opt=$.extend(defaults,options);try{CT.BuildStartCheck()&&(CT.idContiner=that.attr("id"),CT.MountPrincipalContainer(that),CT.Init.call(that))}catch(err){console.error(err)}}return this}}(jQuery);