/** 
 * @class: ComplexityTable jQuery
 * @description: Classe para criação da tabela com cabeçalhos e dados dinamicos com congelamento do cabeçalho e colunas
 * @version: 1.0.2
 * @author: Thiago Adriano <thiago.s.adriano@gmail.com>
 * @copyright: Thiago Adriano ©2016
 * @license: MIT license
*/
!function($){"use strict";var CT={};CT.existGroup=!1,CT.Page=1,CT.TotalRegistros=0,CT.TotalPages=0,CT.Params="",CT.COlTotal=0,CT.idContiner=null;var opt={},htmlTemplate='<div class="ct-wrap"><div class="ct-wraper"><table><thead></thead><tbody></tbody></table></div></div>',wrap=$(htmlTemplate),wraper=wrap.find(".ct-wraper"),table=wraper.find("table"),thead=table.find("thead"),tbody=table.find("tbody"),defaults={urlDados:"",urlCabecalho:"",parametros:[],limite:0,destacar:!1,Tamanhos:{celula:{width:95,height:30},PrimeiraCelula:{width:150,height:30},UltimaCelula:{width:150,height:30}},container:{width:900,height:528},colFixedLeft:!1,colFixedRight:!1,classes:{fixedLeft:"fixed-left",fixedRight:"fixed-right",fixedCol:"fixed-col",bgHeadColor:"head-bg-color",linhaPar:"odd-line",linhaImpar:"even-line",realce:"highlight",existeRealce:"hl-show"},nomePropriedades:{indicador:"indicador",valores:"status",registros:"totalRegistros",cabecalhos:"cabecalhos"}};CT.getHead=function(url,callback){$.ajax({url:url+CT.URLParams(),method:"GET",async:!1,success:function(res){CT.CheckIntegrityProperty(res,opt.nomePropriedades.cabecalhos)&&CT.CheckIntegrityProperty(res,opt.nomePropriedades.registros)&&(CT.TotalRegistros=res[opt.nomePropriedades.registros],CT.setTotalPages(),CT.checkExistGroup(res[opt.nomePropriedades.cabecalhos]),callback(res[opt.nomePropriedades.cabecalhos]))},error:function(err,e,w,r){throw CT.ExceptionError("Erro inesperado aconteceu ao carregar as informações de cabeçalhos.<br><br>"+err.statusText+"<br>"+err.responseText).show(),console.error(err),new Error(err.responseText)}})},CT.getData=function(url,callback){$.ajax({url:url+CT.URLParams(),method:"GET",success:function(res){callback&&callback(res)},error:function(err){throw CT.ExceptionError("Erro inesperado aconteceu ao carregar as informações.<br><br>"+err.statusText+"<br>"+err.responseText).show(),console.error(err),new Error(err.responseText)}})},CT.URLParams=function(){return opt.limite>0?"?skip="+opt.limite+"&page="+CT.Page+CT.Params:"?"+CT.Params.replace(/^&/,"")},CT.setTotalPages=function(){opt.limite>0&&CT.TotalRegistros>0&&(CT.TotalPages=Math.ceil(CT.TotalRegistros/opt.limite))},CT.mountParams=function(){CT.isArray(opt.parametros)&&(opt.parametros.forEach(function(item){for(var j in item)CT.Params+=j+"="+item[j]+"&"}),CT.Params=CT.Params.replace(/&$/,"").replace(/^(.*)/,"&$1"))},CT.DefineTableWidth=function(){return opt.Tamanhos.celula.width*CT.COlTotal+opt.Tamanhos.PrimeiraCelula+opt.Tamanhos.UltimaCelula+"px"},CT.isArray=function(data){return Array.isArray(data)&&data.length>0?data:null},CT.checkExistGroup=function(data){CT.isArray(data)&&data.forEach(function(item){if(null!==item.grupo&&item.grupo.length)return CT.existGroup=!0,!0})},CT.createHead=function(data){var trs=[],trHead=$("<tr/>");if(CT.existGroup){var trGroup=$("<tr/>"),tamW=opt.Tamanhos.celula.width,tamH=opt.Tamanhos.celula.height,leftFirsCol=opt.colFixedLeft?opt.Tamanhos.PrimeiraCelula.width:tamW,calcPrevGroup=0;data.forEach(function(el,i,arr){var th=$("<th/>");null!==el.grupo&&el.grupo.length>0?(CT.HeadTreatment(th,el,tamW,tamH,leftFirsCol,calcPrevGroup,i),trGroup.append(th),CT.HeadSubGroup(el,trHead,tamW,tamH,th),calcPrevGroup=parseInt(th.css("width"))+parseInt(th.css("left"))):(CT.MountHeadNoGroup(th,tamH,el),CT.ConfCheckLastCell(i,arr,th,calcPrevGroup),CT.setFirstCellWidth(i,th),trGroup.append(th),CT.COlTotal++)}),trs.push(trGroup),trs.push(trHead)}else data.forEach(function(el){trHead.append("<th><span>"+el.nome.value+"</span></th>")}),trs.push(trHead);return trs},CT.HeadTreatment=function(th,el,tamW,tamH,leftFirsCol,calcPrevGroup,i){th.html("<span>"+el.nome.value+"</span>").attr("colspan",el.grupo.length).addClass(opt.classes.bgHeadColor).css(CT.configCellGroup(el,tamW,tamH,leftFirsCol,calcPrevGroup,i)),CT.MountLink(el.nome,th)},CT.HeadSubGroup=function(el,trHead,tamW,tamH,th){el.grupo.forEach(function(item,j){var th2l=$("<th><span>"+item.value+"</span></th>");th2l.css(CT.configCellChildrenGroup(tamW,tamH,th,j)).addClass(opt.classes.bgHeadColor),CT.MountLink(item,th2l),trHead.append(th2l),CT.COlTotal++})},CT.MountHeadNoGroup=function(th,tamH,el){th.css(CT.configCellNoGroup(tamH)).html("<span>"+el.nome.value+"</span>").addClass(opt.classes.fixedCol).addClass(opt.classes.bgHeadColor),CT.MountLink(el.nome,th)},CT.NormalizeArray=function(arr){var totalColunasSemPrimeira=CT.COlTotal-1;if(totalColunasSemPrimeira>arr.length)for(var diff=totalColunasSemPrimeira-arr.length,i=0;i<diff;i++)arr.push({value:"--"});return arr},CT.setFirstCellWidth=function(i,th){0===i&&th.css({width:opt.Tamanhos.PrimeiraCelula.width,left:opt.Tamanhos.celula.width*i})},CT.ConfCheckLastCell=function(i,arr,th){i===arr.length-1&&(opt.colFixedRight&&i===arr.length-1?th.css({right:0,width:opt.Tamanhos.UltimaCelula.width}):th.css({left:opt.Tamanhos.celula.width*CT.COlTotal+(opt.Tamanhos.PrimeiraCelula.width-opt.Tamanhos.celula.width),width:opt.Tamanhos.celula.width}))},CT.configCellNoGroup=function(tamH){return{width:opt.Tamanhos.PrimeiraCelula.width,height:CT.existGroup?2*tamH:tamH,top:0,zIndex:3}},CT.configCellChildrenGroup=function(tamW,tamH,th,j){return{width:tamW,height:tamH,left:j>0?parseInt(th.css("left"))+opt.Tamanhos.celula.width*j:th.css("left"),top:tamH}},CT.configCellGroup=function(el,tamW,tamH,leftFirsCol,calcPrevGroup,i){return{width:tamW*el.grupo.length,height:tamH,left:1===i?leftFirsCol*CT.COlTotal:calcPrevGroup}},CT.creteLineData=function(res){if(CT.isArray(res)){var trs=[];return res.forEach(function(item,i){var jumpClasse=i%2===0?opt.classes.linhaPar:opt.classes.linhaImpar,tr=$("<tr/>");CT.HighlightEvent(tr),CT.InsertCellFirstData(item,jumpClasse,tr,i),CT.InsertValues(item,jumpClasse,tr),trs.push(tr)}),trs}return[]},CT.InsertCellFirstData=function(item,jumpClasse,tr,i){if(CT.CheckIntegrityProperty(item,opt.nomePropriedades.indicador)){var tdFirst=$("<td><span>"+item[opt.nomePropriedades.indicador].value+"</span></td>");CT.checkInsertLink(item,tdFirst,!0),opt.colFixedLeft&&tdFirst.addClass(opt.classes.fixedLeft),tdFirst.css(CT.ConfigFirstCell(i)).addClass(jumpClasse),tr.append(tdFirst)}},CT.InsertValues=function(item,jumpClasse,tr){CT.CheckIntegrityProperty(item,opt.nomePropriedades.valores)&&(item[opt.nomePropriedades.valores]=CT.NormalizeArray(item[opt.nomePropriedades.valores]),item[opt.nomePropriedades.valores].forEach(function(val,i,arr){var tdval=$("<td><span>"+val.value+"</span></td>");CT.checkInsertLink(val,tdval),tdval.css(CT.ConfigCell()).addClass(jumpClasse),CT.setFixedCollineData(i,arr,tdval),tr.append(tdval)}))},CT.checkInsertLink=function(itemCol,tdFirst,firstCol){var item=itemCol instanceof Object&&!firstCol?itemCol:firstCol?itemCol[opt.nomePropriedades.indicador]:itemCol[opt.nomePropriedades.valores];if(Array.isArray(item))for(var i in item)CT.MountLink(item[i],tdFirst);else CT.MountLink(item,tdFirst)},CT.MountLink=function(item,celula){if(item.hasOwnProperty("link")&&"#"!==item.link&&""!==item.link){var td=celula,span=td.find("span"),text=span.text(),a=$("<a>"+text+"</a>");a.attr({href:item.link,target:"_blank"}),span.html(""),span.append(a)}},CT.setFixedCollineData=function(i,arr,tdval){opt.colFixedRight&&i===arr.length-1&&tdval.addClass(opt.classes.fixedRight).css(CT.ConfigLastCell())},CT.ConfigFirstCell=function(i){return{height:opt.Tamanhos.PrimeiraCelula.height,width:opt.Tamanhos.PrimeiraCelula.width,minWidth:opt.Tamanhos.PrimeiraCelula.width,maxWidth:opt.Tamanhos.PrimeiraCelula.width,top:opt.Tamanhos.celula.height*i+(CT.existGroup?2*opt.Tamanhos.celula.height:opt.Tamanhos.celula.height)+i}},CT.ConfigLastCell=function(){return{width:opt.Tamanhos.UltimaCelula.width,minWidth:opt.Tamanhos.UltimaCelula.width,maxWidth:opt.Tamanhos.UltimaCelula.width}},CT.ConfigCell=function(){return{height:opt.Tamanhos.celula.height,width:opt.Tamanhos.celula.width,maxWidth:opt.Tamanhos.celula.width,minWidth:opt.Tamanhos.celula.width}},CT.insertHead=function(el,callback){CT.getHead(opt.urlCabecalho,function(res){CT.createHead(res).forEach(function(el){thead.append($(el))}),CT.getData(opt.urlDados,function(res){CT.creteLineData(res).forEach(function(el){tbody.append(el)}),callback(el)})})},CT.scrollEvent=function(){wraper.on("scroll",function(e){var trs=tbody.find("tr"),fixedL=tbody.find("."+opt.classes.fixedLeft),fixedR=tbody.find("."+opt.classes.fixedRight),tds=trs.eq(0).find("td"),ths=thead.find("th").filter(function(){if(!$(this).hasClass(opt.classes.fixedCol))return this}),thCell=[],thGroup=[];ths.filter(function(){$(this).attr("colspan")?thGroup.push(this):thCell.push(this)});var tempPosi=1,totalGrupo=thGroup.length,grupoPercorrido=0;trs.each(function(i,item){var position=$(item).position();fixedL.eq(i).css("top",position.top),fixedR.eq(i).css("top",position.top)}),tds.each(function(i,item){var position=$(item).position(),id=i-1;$(thCell).eq(id).css("left",position.left),i===tempPosi&&grupoPercorrido<totalGrupo&&($(thGroup).eq(grupoPercorrido).css("left",position.left),tempPosi+=parseInt($(thGroup).eq(grupoPercorrido).attr("colspan")),grupoPercorrido++)}),CT.getDataScroll(e)})},CT.getDataScroll=function(e){var temptr=table.find("tbody tr"),posiLasttr=temptr.eq(temptr.length-1).offset().top,posi=e.currentTarget.offsetTop+parseInt(wraper.height(),10);opt.limite>0&&posi>=posiLasttr&&CT.Page<=CT.TotalPages&&CT.getData(opt.urlDados,function(res){CT.Page++})},CT.HighlightEvent=function(el){opt.destacar&&(el.addClass(opt.classes.existeRealce),el.on("click",function(){$(this).hasClass(opt.classes.realce)?$(this).removeClass(opt.classes.realce):$(this).addClass(opt.classes.realce)}))},CT.MountPrincipalContainer=function(el){$(el).css({position:"relative",width:opt.container.width,height:opt.container.height,marginLeft:"auto",marginRight:"auto"})},CT.MountTable=function(el){CT.MountContainer(),table.css({width:CT.DefineTableWidth()}),el.append(wrap),CT.Loading().hide(),CT.Alert("Dados carregados com sucesso!",1).showInterval(2e3)},CT.MountContainer=function(){var heightGroup=CT.existGroup?2*opt.Tamanhos.celula.height:opt.Tamanhos.celula.height,widthPadding=opt.colFixedLeft?opt.Tamanhos.PrimeiraCelula.width:0,widthfixColRigth=opt.colFixedRight?opt.Tamanhos.UltimaCelula.width:0;wrap.css({width:opt.container.width-widthPadding,height:opt.container.height-heightGroup,paddingLeft:widthPadding,paddingTop:heightGroup,background:opt.corCabecalho}),wraper.css({width:opt.container.width-(widthPadding+widthfixColRigth),height:opt.container.height-heightGroup})},CT.Loading=function(el){var template=$("<div class='ct-loader'><p>Aguarde, Carregando...</p></div>");return{show:function(){$(el).append(template)},hide:function(){$(".ct-loader").fadeOut("1000",function(){$(this).remove()})}}},CT.ExceptionError=function(msg){var template=$("<div id='ct-exception'><h2>Erro na aplicação</h2><p></p></div>"),p=template.find("p");return p.html(msg),{show:function(){$("#"+CT.idContiner).find("div").remove(),$("#"+CT.idContiner).html(""),$("#"+CT.idContiner).append(template)},hide:function(){$("#ct-exception").fadeOut("1000",function(){$(this).remove()})}}},CT.Alert=function(msg,type){var typeEvent=1===type?"ct-success":2===type?"ct-warning":"ct-error",id="ct-info",template=$('<div id="'+id+'" class="'+typeEvent+'" ><button type="button">X</button><p></p></div>'),p=template.find("p"),button=template.find("button"),txtMsg=null!==msg&&""!==msg&&void 0!==msg?msg:"Erro ao realizar o procedimento.";p.text(txtMsg);var clicked=function(){button.on("click",function(){_close()})},_show=function(){$("#"+id).is(":visible")&&$("#"+id).remove(),clicked(),$("body").append(template)},_close=function(){$("#"+id).fadeOut(800,function(){$(this).remove()})},_showInterval=function(time){var timer=time||5e3;_show(),setTimeout(_close,timer)};return{show:_show,close:_close,showInterval:_showInterval}},CT.Init=function(){var that=this;CT.Loading(that).show(),CT.mountParams(opt.parametros),CT.insertHead(that,CT.MountTable),CT.scrollEvent()},CT.BuildStartCheck=function(){if(!opt.urlCabecalho&&""===opt.urlCabecalho)throw CT.Alert("A URL para buscar os  cabecalhos a serem inseridos não foi informada.",2).show(),new Error("Necessário informar url para buscar os cabeçalhos");if(!opt.urlDados&&""===opt.urlDados)throw CT.Alert("A URL para buscar os valores a serem inseridos não foi informada.",2).show(),new Error("Necessário informar url para buscar os dados");return!0},CT.CheckIntegrityProperty=function(data,prop){try{if(!data.hasOwnProperty(prop))throw new Error("A propriedade: <strong>"+prop+"</strong>, não faz parte dos dados. <br>"+JSON.stringify(data))}catch(e){CT.ExceptionError("Os dados possuem inconsistência<br><br>"+e).show(),console.error(e)}return!0},$.fn.ComplexityTable=function(options){var that=this;opt=$.extend(defaults,options);try{CT.BuildStartCheck()&&(CT.idContiner=that.attr("id"),CT.MountPrincipalContainer(that),CT.Init.call(that))}catch(err){console.error(err)}return this}}(jQuery);